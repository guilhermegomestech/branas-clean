name: Enviar Pull Request

on:
  pull_request:
    types: 
      - closed
    branches:
      - develop

jobs:
  sync-branches:
    runs-on: ubuntu-latest
    name: Syncing branches
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Set up Node
        uses: actions/setup-node@v1
        with:
          node-version: 12
          
      - name: Obter nome da branch do PR
        run: |
          pr_branch=${GITHUB_HEAD_REF}
          echo "Branch do PR: $pr_branch"
          
      - name: Obter nome da branch
        run: |
          # Extrair apenas o nome da branch da variável GITHUB_REF
          branch_name=${GITHUB_REF#refs/heads/}
          echo "Branch corrente: $branch_name"
          
      - name: Install GitHub CLI
        run: |
          OS=$(uname -s | tr '[:upper:]' '[:lower:]')
          ARCH=$(uname -m)
          VERSION=<2.0.0>
          curl -LO "https://github.com/cli/cli/releases/download/v${VERSION}/gh_${VERSION}_${OS}_${ARCH}.tar.gz"
          tar xvf gh_${VERSION}_${OS}_${ARCH}.tar.gz
          sudo mv gh_${VERSION}_${OS}_${ARCH}/bin/gh /usr/local/bin/gh


    
      - name: Get Branches
        uses: actions/github-script@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const response = await github.repos.listBranches({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const branches = response.data.map(branch => branch.name);
            core.setOutput('branches', branches.join(','));
            
      - name: Create Pull Requests
        run: |
          branches=$(echo "${{ steps.GetBranches.outputs.branches }}" | tr ',' '\n')
          for branch in $branches; do
            gh pr create --base main --head $branch --title "Atualização da branch $branch" --body "Essa é uma atualização automática da branch $branch."
          done
